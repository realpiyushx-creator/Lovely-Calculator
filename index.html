<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Luxe Calculator (Stable)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #ff2e93;
      --secondary-color: #ff88c2;
      --accent-glow: rgba(255, 46, 147, 0.6);
      --glass-bg: rgba(18, 18, 28, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #a0a0b0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      overflow: hidden;
      background-color: #0f0c29;
      color: var(--text-main);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .aurora-bg {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      z-index: -2;
    }

    .aurora-blob {
      position: absolute;
      filter: blur(80px);
      opacity: 0.5;
      animation: floatBlob 20s infinite alternate ease-in-out;
      border-radius: 50%;
    }

    .blob-1 {
      background: #ff2e93;
      width: 500px;
      height: 500px;
      top: -10%;
      left: -10%;
      animation-delay: 0s;
    }

    .blob-2 {
      background: #00d2ff;
      width: 400px;
      height: 400px;
      bottom: -10%;
      right: -5%;
      animation-delay: -5s;
    }

    .blob-3 {
      background: #9d50bb;
      width: 300px;
      height: 300px;
      top: 40%;
      left: 40%;
      animation-delay: -10s;
      opacity: 0.3;
    }

    @keyframes floatBlob {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(30px, -50px) scale(1.1); }
    }

    #tilt-wrapper {
      transform-style: preserve-3d;
      transition: transform 0.15s ease-out;
      perspective: 1000px;
    }

    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border);
      box-shadow:
        0 20px 50px rgba(0, 0, 0, 0.5),
        inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      border-radius: 40px;
      overflow: hidden;
      position: relative;
    }

    .display-area {
      background: rgba(0, 0, 0, 0.2);
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .cursor-blink {
      animation: blink 1s step-end infinite;
      border-right: 2px solid var(--primary-color);
    }

    @keyframes blink {
      50% { border-color: transparent; }
    }

    .btn-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 20px;
    }

    .calc-btn {
      height: 65px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(255, 255, 255, 0.03);
      color: white;
      font-size: 1.5rem;
      font-weight: 400;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calc-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .calc-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-op {
      color: var(--secondary-color);
      font-weight: 600;
      background: rgba(255, 46, 147, 0.05);
    }

    .btn-op:hover {
      background: rgba(255, 46, 147, 0.15);
      box-shadow: 0 0 15px var(--accent-glow);
    }

    .btn-equal {
      background: linear-gradient(135deg, #ff2e93, #ff88c2);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(255, 46, 147, 0.4);
    }

    .btn-equal:hover {
      box-shadow: 0 0 30px rgba(255, 46, 147, 0.6);
      transform: translateY(-2px) scale(1.02);
    }

    .btn-danger {
      color: #ff4757;
      background: rgba(255, 71, 87, 0.05);
    }

    .btn-danger:hover {
      background: rgba(255, 71, 87, 0.15);
    }

    .sci-drawer {
      height: 0;
      overflow: hidden;
      transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(0, 0, 0, 0.1);
    }

    .sci-drawer.open {
      height: 60px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sci-btn {
      font-size: 0.9rem;
      height: 45px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .history-panel {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 0;
      background: rgba(15, 15, 25, 0.95);
      backdrop-filter: blur(30px);
      transition: width 0.3s ease;
      z-index: 50;
      overflow: hidden;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

    .history-panel.open { width: 240px; }

    .history-item {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: background 0.2s;
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .scrollbar-hide::-webkit-scrollbar {
      width: 0;
      height: 0;
    }
  </style>
</head>
<body class="flex items-center justify-center h-screen">

<div class="aurora-bg">
  <div class="aurora-blob blob-1"></div>
  <div class="aurora-blob blob-2"></div>
  <div class="aurora-blob blob-3"></div>
</div>

<div id="tilt-wrapper" class="relative z-10 w-full max-w-[380px] px-4">
  <div class="glass-panel flex flex-col min-h-[600px]">

    <!-- Top Bar -->
    <div class="flex justify-between items-center p-5 pb-2 opacity-80">
      <button id="btn-history" class="p-2 hover:text-pink-400 transition-colors">
        <i class="fa-solid fa-clock-rotate-left"></i>
      </button>
      <span class="text-xs font-bold tracking-[0.2em] text-pink-300 uppercase">Luxe Math</span>
      <button id="btn-sci" class="p-2 hover:text-cyan-400 transition-colors">
        <i class="fa-solid fa-flask"></i>
      </button>
    </div>

    <!-- Display -->
    <div class="display-area flex flex-col justify-end items-end p-6 mb-2 h-[140px]">
      <div id="prev-calc" class="text-gray-400 text-sm font-light h-6 mb-1 tracking-wide"></div>
      <div id="display-wrapper" class="w-full overflow-hidden text-right">
        <span id="display" class="text-5xl font-light text-white cursor-blink whitespace-nowrap">0</span>
      </div>
    </div>

    <!-- Sci Drawer -->
    <div id="sci-drawer" class="sci-drawer px-4 flex items-center justify-between gap-2">
      <button data-func="sin" class="sci-btn flex-1 text-cyan-300">sin</button>
      <button data-func="cos" class="sci-btn flex-1 text-cyan-300">cos</button>
      <button data-func="sqrt" class="sci-btn flex-1 text-cyan-300">√</button>
      <button data-func="pow" class="sci-btn flex-1 text-cyan-300">x²</button>
      <button data-input="3.14159" class="sci-btn flex-1 text-cyan-300">π</button>
    </div>

    <!-- Keypad -->
    <div class="btn-grid flex-1" id="keypad">
      <button data-action="clear" class="calc-btn btn-danger text-lg font-bold">AC</button>
      <button data-action="delete" class="calc-btn btn-danger"><i class="fa-solid fa-delete-left"></i></button>
      <button data-op="%" class="calc-btn btn-op"><i class="fa-solid fa-percent text-sm"></i></button>
      <button data-op="/" class="calc-btn btn-op"><i class="fa-solid fa-divide"></i></button>

      <button data-input="7" class="calc-btn">7</button>
      <button data-input="8" class="calc-btn">8</button>
      <button data-input="9" class="calc-btn">9</button>
      <button data-op="*" class="calc-btn btn-op"><i class="fa-solid fa-xmark"></i></button>

      <button data-input="4" class="calc-btn">4</button>
      <button data-input="5" class="calc-btn">5</button>
      <button data-input="6" class="calc-btn">6</button>
      <button data-op="-" class="calc-btn btn-op"><i class="fa-solid fa-minus"></i></button>

      <button data-input="1" class="calc-btn">1</button>
      <button data-input="2" class="calc-btn">2</button>
      <button data-input="3" class="calc-btn">3</button>
      <button data-op="+" class="calc-btn btn-op"><i class="fa-solid fa-plus"></i></button>

      <button data-input="0" class="calc-btn col-span-2" style="justify-content: flex-start; padding-left: 2rem;">0</button>
      <button data-input="." class="calc-btn">.</button>
      <button id="btn-equal" data-action="equal" class="calc-btn btn-equal">
        <i class="fa-solid fa-equals"></i>
      </button>
    </div>

    <!-- History Panel -->
    <div id="history-panel" class="history-panel flex flex-col">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <span class="font-bold text-pink-400">History</span>
        <button id="btn-history-close" class="text-gray-400 hover:text-white">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div id="history-list" class="flex-1 overflow-y-auto p-2 scrollbar-hide">
        <div class="text-center text-gray-600 mt-10 text-sm">No calculations yet</div>
      </div>
      <button id="btn-history-clear"
              class="m-4 p-2 bg-red-500/20 text-red-300 rounded-lg text-sm hover:bg-red-500/30">
        Clear All
      </button>
    </div>

  </div>
</div>

<script>
  let currentExp = '0';
  let history = [];

  const displayEl = document.getElementById('display');
  const prevEl = document.getElementById('prev-calc');
  const historyPanel = document.getElementById('history-panel');
  const historyListEl = document.getElementById('history-list');
  const sciDrawer = document.getElementById('sci-drawer');
  const tiltWrapper = document.getElementById('tilt-wrapper');

  function render() {
    let view = currentExp.replace(/\*/g, '×').replace(/\//g, '÷');
    if (view === '') view = '0';
    displayEl.innerText = view;

    const len = view.length;
    if (len > 14) displayEl.style.fontSize = '1.5rem';
    else if (len > 9) displayEl.style.fontSize = '2.5rem';
    else displayEl.style.fontSize = '3.5rem';
  }

  function handleInput(val) {
    if (currentExp === '0' && val !== '.') currentExp = val;
    else currentExp += val;
    render();
  }

  function handleOp(val) {
    const last = currentExp.slice(-1);
    if (['+', '-', '*', '/', '%'].includes(last)) {
      currentExp = currentExp.slice(0, -1) + val;
    } else {
      currentExp += val;
    }
    render();
  }

  function handleFunc(type) {
    if (currentExp === '0') currentExp = '';

    if (type === 'sqrt') currentExp += 'Math.sqrt(';
    else if (type === 'sin') currentExp += 'Math.sin(';
    else if (type === 'cos') currentExp += 'Math.cos(';
    else if (type === 'pow') currentExp += '**2';

    render();
  }

  function handleDelete() {
    if (currentExp.length === 1) currentExp = '0';
    else currentExp = currentExp.slice(0, -1);
    render();
  }

  function handleClear() {
    currentExp = '0';
    prevEl.innerText = '';
    render();
  }

  function addToHistory(expr, res) {
    history.unshift({ expr, res, time: new Date().toLocaleTimeString() });
    updateHistoryUI();
  }

  function updateHistoryUI() {
    if (history.length === 0) {
      historyListEl.innerHTML =
        '<div class="text-center text-gray-600 mt-10 text-sm">No calculations yet</div>';
      return;
    }
    historyListEl.innerHTML = history.map(h => `
      <div class="history-item flex flex-col" data-load="${h.res}">
        <span class="text-xs text-gray-500 text-right">${h.expr}</span>
        <span class="text-xl text-pink-300 font-mono text-right">= ${h.res}</span>
      </div>
    `).join('');
  }

  function calculate() {
    try {
      if (currentExp === '520' || currentExp === '1314') {
        prevEl.innerText = "Secret Code Found ❤️";
        return;
      }

      let evalStr = currentExp.replace(/×/g, '*').replace(/÷/g, '/');

      // fix brackets if uneven
      const open = (evalStr.match(/\(/g) || []).length;
      const close = (evalStr.match(/\)/g) || []).length;
      if (open > close) evalStr += ')'.repeat(open - close);

      // eslint-disable-next-line no-eval
      const result = eval(evalStr);

      if (!isFinite(result) || isNaN(result)) throw new Error("Invalid");

      addToHistory(currentExp, result);

      prevEl.innerText = currentExp + ' =';
      currentExp = String(parseFloat(result.toFixed(8)));
      render();
    } catch (e) {
      prevEl.innerText = "Error";
      shakeScreen();
    }
  }

  function toggleHistory() {
    historyPanel.classList.toggle('open');
  }

  function clearHistory() {
    history = [];
    updateHistoryUI();
  }

  function toggleScientific() {
    sciDrawer.classList.toggle('open');
  }

  function shakeScreen() {
    const el = document.querySelector('.glass-panel');
    el.style.transform = 'translateX(5px)';
    setTimeout(() => el.style.transform = 'translateX(-5px)', 50);
    setTimeout(() => el.style.transform = 'translateX(5px)', 100);
    setTimeout(() => el.style.transform = 'translateX(0)', 150);
  }

  // Keypad events (no 'event' param issues)
  document.getElementById('keypad').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const valInput = btn.getAttribute('data-input');
    const valOp = btn.getAttribute('data-op');
    const action = btn.getAttribute('data-action');

    if (valInput !== null) {
      handleInput(valInput);
    } else if (valOp !== null) {
      handleOp(valOp);
    } else if (action === 'clear') {
      handleClear();
    } else if (action === 'delete') {
      handleDelete();
    } else if (action === 'equal') {
      calculate();
    }
  });

  // Sci drawer events
  sciDrawer.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const f = btn.getAttribute('data-func');
    const input = btn.getAttribute('data-input');

    if (f) handleFunc(f);
    if (input) handleInput(input);
  });

  // History buttons
  document.getElementById('btn-history').addEventListener('click', toggleHistory);
  document.getElementById('btn-history-close').addEventListener('click', toggleHistory);
  document.getElementById('btn-history-clear').addEventListener('click', clearHistory);

  historyListEl.addEventListener('click', (e) => {
    const row = e.target.closest('[data-load]');
    if (!row) return;
    const val = row.getAttribute('data-load');
    currentExp = String(val);
    render();
    toggleHistory();
  });

  // Sci toggle
  document.getElementById('btn-sci').addEventListener('click', toggleScientific);

  // Tilt effect (pure visual, no errors)
  function handleTilt(clientX, clientY) {
    const rect = tiltWrapper.getBoundingClientRect();
    const x = (clientX - rect.left - rect.width / 2) / rect.width;
    const y = (clientY - rect.top - rect.height / 2) / rect.height;

    const rotateX = y * 10;
    const rotateY = -x * 10;
    tiltWrapper.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
  }

  tiltWrapper.addEventListener('mousemove', (e) => {
    handleTilt(e.clientX, e.clientY);
  });

  tiltWrapper.addEventListener('mouseleave', () => {
    tiltWrapper.style.transform = 'rotateX(0deg) rotateY(0deg)';
  });

  tiltWrapper.addEventListener('touchmove', (e) => {
    const t = e.touches[0];
    handleTilt(t.clientX, t.clientY);
  }, { passive: true });

  tiltWrapper.addEventListener('touchend', () => {
    tiltWrapper.style.transform = 'rotateX(0deg) rotateY(0deg)';
  });

  render();
</script>
</body>
</html>
